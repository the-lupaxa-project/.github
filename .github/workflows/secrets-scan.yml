# -----------------------------------------------------------------------------
# Workflow: Secrets scan
# Purpose:
#   - Scans the repository for leaked secrets such as:
#       • API keys
#       • Tokens
#       • Private keys
#       • Credentials
#   - Runs on every push, pull request, and manual trigger.
#   - Uses a reusable workflow so all Lupaxa repositories enforce the same
#     secret-scanning rules and tooling.
#   - Aggregates results into a single status job.
#   - Optionally posts Slack notifications when failures or timeouts occur.
#
# Security impact:
#   - Prevents accidental credential leaks.
#   - Acts as an early warning system before secrets are merged or deployed.
# -----------------------------------------------------------------------------
name: Secrets scan

# -----------------------------------------------------------------------------
# Triggers
# -----------------------------------------------------------------------------
on:
  # Run on any branch push.
  # Ensures secrets are detected immediately, even outside PR workflows.
  push:
    branches:
      - "**"          # run on any branch push

  # Run on all pull requests.
  # Prevents secrets from being merged into protected branches.
  pull_request:

  # Allow manual execution from the GitHub UI.
  workflow_dispatch:

# -----------------------------------------------------------------------------
# Concurrency
# -----------------------------------------------------------------------------
concurrency:
  # Ensures only one instance of this workflow runs per ref.
  # If a new commit is pushed while a scan is running,
  # the in-progress run is cancelled and replaced.
  # This avoids wasted CI time and duplicated scans.
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# -----------------------------------------------------------------------------
# Permissions
# -----------------------------------------------------------------------------
permissions:
  # Required to read workflow/job metadata.
  actions: read

  # Required to read repository contents during scanning.
  contents: read

  # Required to read pull request data if annotations or reports are posted.
  pull-requests: read

jobs:
  # ---------------------------------------------------------------------------
  # Job: secrets-scan
  # What it does:
  #   - Calls a reusable workflow that:
  #       • Scans the codebase for secret patterns
  #       • Detects exposed credentials
  #       • Fails the job if any are found
  # Why it exists:
  #   - Protects against accidental credential leaks.
  #   - Enforces security hygiene across all Lupaxa projects.
  # Implementation:
  #   - Centralized in a reusable workflow for consistency and maintainability.
  # Secrets:
  #   - `secrets: inherit` passes all repository secrets into the reusable
  #     workflow if required for authentication or configuration.
  # ---------------------------------------------------------------------------
  secrets-scan:
    name: Secrets Scan
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-secrets-scan.yml@master
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Job: status-check
  # What it does:
  #   - Runs after `secrets-scan`.
  #   - Aggregates its result into one definitive workflow outcome.
  # Why it exists:
  #   - Provides a single “gate” job for CI visibility and automation.
  #   - Simplifies Slack notification logic.
  # `if: always()`:
  #   - Ensures this job runs even if the secrets scan fails or is cancelled.
  # Important:
  #   - This is a *job-level* reusable workflow call, not a step.
  # ---------------------------------------------------------------------------
  status-check:
    name: Secrets Scan Status
    needs:
      - secrets-scan
    if: always()
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-check-jobs-status.yml@master

  # ---------------------------------------------------------------------------
  # Job: slack-workflow-status
  # What it does:
  #   - Posts the workflow result to Slack using a reusable workflow.
  #   - Triggered after the aggregated `status-check` job completes.
  # Why it exists:
  #   - Immediately alerts maintainers if a secret is detected or the scan fails.
  #   - Keeps security incidents highly visible.
  # Noise control:
  #   - Only notifies on failure or timeout, not on success.
  # `ignore_jobs`:
  #   - Excludes the aggregator job from Slack summaries to reduce clutter.
  # Secrets:
  #   - Requires SLACK_WEBHOOK_URL to exist in repository secrets.
  # ---------------------------------------------------------------------------
  slack-workflow-status:
    name: Slack Post Workflow Notification
    needs:
      - status-check
    if: always()
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-slack-workflow-status.yml@master
    with:
      # Comma-separated list of outcomes that should trigger Slack notifications.
      notify_on_results: "failure,timed_out"

      # Jobs to exclude from Slack message details.
      ignore_jobs: "Check Jobs Status"
    secrets:
      # Maps the repository’s Slack webhook secret into the reusable workflow.
      slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
