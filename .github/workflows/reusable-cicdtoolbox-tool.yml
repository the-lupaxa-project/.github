name: Reusable CICDToolbox Tool Runner

on:
  workflow_call:
    inputs:
      tool:
        description: >
          Name of the CICDToolbox repository (e.g. "markdown-lint", "yaml-lint",
          "shellcheck", "bandit", "pylint", "hadolint", etc.).
        required: true
        type: string

      include_files:
        description: >
          Optional comma-separated list of file globs to include.
          (Mapped to INCLUDE_FILES for CICDToolbox tools that support it.)
        required: false
        type: string
        default: ""

      exclude_files:
        description: >
          Optional comma-separated list of file globs to exclude.
          (Mapped to EXCLUDE_FILES for CICDToolbox tools that support it.)
        required: false
        type: string
        default: ""

      report_only:
        description: >
          If supported by the tool, run in report-only mode (no hard failure).
        required: false
        type: boolean
        default: false

      no_color:
        description: >
          Disable coloured output if supported by the tool.
        required: false
        type: boolean
        default: false

      show_errors:
        description: >
          If supported by the tool, show only errors (not warnings / info).
        required: false
        type: boolean
        default: false

      show_skipped:
        description: >
          If supported by the tool, include skipped / ignored files in output.
        required: false
        type: boolean
        default: false

    secrets:
      github-token:
        description: >
          Optional GitHub token if a tool ever needs API access.
        required: false

jobs:
  run-tool:
    name: Run ${{ inputs.tool }} from CICDToolbox
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate tool name
        id: validate
        run: |
          tool="${{ inputs.tool }}"

          if [ -z "${tool}" ]; then
            echo "ERROR: 'tool' input must not be empty." >&2
            exit 1
          fi

          if [ "${tool}" = "get-all-tools" ]; then
            echo "ERROR: The 'get-all-tools' repo is an installer script, not a CI tool. Refusing to run it via this workflow." >&2
            exit 1
          fi

          echo "tool=${tool}" >> "${GITHUB_OUTPUT}"

      - name: Run CICDToolbox tool pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.github-token }}
          # Common envs used by many CICDToolbox tools. If a given tool
          # doesnâ€™t use one, it will simply ignore it.
          INCLUDE_FILES: ${{ inputs.include_files }}
          EXCLUDE_FILES: ${{ inputs.exclude_files }}
          REPORT_ONLY: ${{ inputs.report_only }}
          NO_COLOR: ${{ inputs.no_color }}
          SHOW_ERRORS: ${{ inputs.show_errors }}
          SHOW_SKIPPED: ${{ inputs.show_skipped }}
        run: |
          set -euo pipefail

          TOOL="${{ steps.validate.outputs.tool }}"

          echo "==> Running CICDToolbox tool: ${TOOL}"
          echo "    Repo : https://github.com/CICDToolbox/${TOOL}"
          echo "    Script: pipeline.sh on 'master' branch"

          # Note: CICDToolbox tools provide their own pipeline.sh script which
          # installs any language-specific dependencies they require.
          bash <(curl -s "https://raw.githubusercontent.com/CICDToolbox/${TOOL}/master/pipeline.sh")
