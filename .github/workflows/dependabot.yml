# -----------------------------------------------------------------------------
# Workflow: Dependabot
# Purpose:
#   - Runs on every pull request.
#   - Delegates the real work to reusable workflows from the Lupaxa workflows repo.
#   - Adds a status aggregation job (so you get a single pass/fail outcome).
#   - Optionally posts Slack notifications on failure/timed-out runs.
# -----------------------------------------------------------------------------
name: Dependabot

# -----------------------------------------------------------------------------
# Triggers
# -----------------------------------------------------------------------------
on:
  # Run this workflow for any PR (including Dependabot PRs and human PRs).
  # If you want to restrict to only Dependabot PRs later, you can add an `if:`
  # on jobs or use `pull_request_target` with care (security considerations).
  pull_request:

# -----------------------------------------------------------------------------
# Concurrency
# -----------------------------------------------------------------------------
concurrency:
  # Ensure only one run per PR ref is active at once.
  # If new commits are pushed to the PR, the in-progress run is cancelled and
  # replaced by the latest run to avoid wasted CI minutes / duplicate checks.
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# -----------------------------------------------------------------------------
# Permissions (least privilege for what the reusable workflows need)
# -----------------------------------------------------------------------------
permissions:
  # Read workflow metadata / actions info (commonly needed by status tooling).
  actions: read

  # Allow updating repository contents (e.g., Dependabot automation may
  # modify files, update lockfiles, or commit changes depending on config).
  contents: write

  # Allow interacting with PRs (e.g., labels, comments, approvals, merging).
  pull-requests: write

jobs:
  # ---------------------------------------------------------------------------
  # Job: dependabot (delegated via reusable workflow)
  # What it does:
  #   - Calls the central reusable Dependabot workflow that lives in:
  #       the-lupaxa-project/workflows/.github/workflows/reusable-dependabot.yml
  #   - Keeps all Dependabot logic consistent across repos.
  # Notes:
  #   - `secrets: inherit` passes *this repo's* secrets to the reusable workflow.
  # ---------------------------------------------------------------------------
  dependabot:
    name: Dependabot (Reusable)
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-dependabot.yml@master
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Job: status-check (aggregates overall workflow status)
  # What it does:
  #   - Runs after `dependabot` completes.
  #   - Calls a reusable workflow that checks the results of upstream jobs and
  #     produces a single "overall" status outcome.
  # Why it exists:
  #   - Makes it easier to reason about CI results (one gate).
  #   - Helps Slack alerts / branch protection depend on a single job if desired.
  # Important:
  #   - This is a *job-level* reusable workflow call (uses:), not steps.
  # `if: always()`:
  #   - Ensures this job runs even if `dependabot` fails/cancels, so you still
  #     get a definitive aggregated status.
  # ---------------------------------------------------------------------------
  status-check:
    name: Check Jobs Status
    needs:
      - dependabot
    if: always()
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-check-jobs-status.yml@master

  # ---------------------------------------------------------------------------
  # Job: slack-workflow-status (notifies Slack on important outcomes)
  # What it does:
  #   - Posts a Slack notification using a reusable workflow.
  #   - Configured to notify only for failure or timed_out outcomes.
  # `needs: status-check`:
  #   - Ensures Slack is driven from the aggregated result, not partial job state.
  # `if: always()`:
  #   - Ensures Slack can post even if upstream jobs fail/cancel, as long as the
  #     status-check job executes (which it will, due to its own always()).
  # `ignore_jobs`:
  #   - Excludes the aggregator job from the Slack message/details to reduce noise.
  # Secrets:
  #   - Expects `SLACK_WEBHOOK_URL` to exist in this repository secrets.
  # ---------------------------------------------------------------------------
  slack-workflow-status:
    name: Slack Post Workflow Notification
    needs:
      - status-check
    if: always()
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-slack-workflow-status.yml@master
    with:
      # Comma-separated list of results that should trigger a Slack message.
      notify_on_results: "failure,timed_out"

      # Comma-separated list of job names to exclude from notification summaries.
      ignore_jobs: "Check Jobs Status"
    secrets:
      # Maps local secret name -> reusable workflow input secret name.
      slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
