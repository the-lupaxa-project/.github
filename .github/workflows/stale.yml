# -----------------------------------------------------------------------------
# Workflow: Stale Issue & PR Handler
# Purpose:
#   - Automatically manages stale issues and pull requests.
#   - Helps keep repositories clean, active, and maintainable.
#   - Typically performs actions such as:
#       • Marking inactive issues/PRs as stale
#       • Adding comments or labels
#       • Closing items that remain inactive after a grace period
#   - Uses a reusable workflow so the same stale-handling policy is enforced
#     consistently across all Lupaxa repositories.
#   - Aggregates results into a single status job.
#   - Optionally posts Slack notifications when failures or timeouts occur.
# -----------------------------------------------------------------------------
name: Stale Issue & PR Handler

# -----------------------------------------------------------------------------
# Triggers
# -----------------------------------------------------------------------------
on:
  # Scheduled execution:
  # Runs every day at 05:35 UTC.
  # This ensures stale items are processed regularly without manual action.
  schedule:
    - cron: "35 5 * * *"

  # Allow manual execution from the GitHub UI.
  # Useful for testing configuration changes or forcing an immediate cleanup.
  workflow_dispatch:

# -----------------------------------------------------------------------------
# Concurrency
# -----------------------------------------------------------------------------
concurrency:
  # Ensures only one instance of this workflow runs per ref at a time.
  # If the scheduled job overlaps with a manual trigger, the older run
  # will be cancelled and replaced by the newer one.
  # This avoids duplicated processing and API rate-limit issues.
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# -----------------------------------------------------------------------------
# Permissions
# -----------------------------------------------------------------------------
permissions:
  # Required to read workflow/job metadata.
  actions: read

  # Required to read repository contents if configuration files are needed.
  contents: read

  # Required to comment on, label, and close issues.
  issues: write

  # Required to comment on, label, and close pull requests.
  pull-requests: write

jobs:
  # ---------------------------------------------------------------------------
  # Job: stale
  # What it does:
  #   - Calls a reusable workflow that:
  #       • Finds issues and PRs with no activity for a defined time period
  #       • Marks them as stale (usually with a label and comment)
  #       • Optionally closes them after further inactivity
  # Why it exists:
  #   - Prevents long-term accumulation of abandoned issues and PRs.
  #   - Encourages contributors to update or close inactive work.
  #   - Keeps project backlogs realistic and actionable.
  # Implementation:
  #   - Centralized in a reusable workflow so stale policies are identical
  #     across all Lupaxa repositories.
  # ---------------------------------------------------------------------------
  stale:
    name: Run Stale Issue & PR Handler
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-stale.yml@master

  # ---------------------------------------------------------------------------
  # Job: status-check
  # What it does:
  #   - Runs after the stale handler job.
  #   - Aggregates its result into a single, definitive workflow status.
  # Why it exists:
  #   - Provides one “gate” job for monitoring and notifications.
  #   - Simplifies Slack integration and operational visibility.
  # `if: always()`:
  #   - Ensures this job runs even if the stale handler fails or is cancelled.
  # Important:
  #   - This is a *job-level* reusable workflow call, not a step.
  # ---------------------------------------------------------------------------
  status-check:
    name: Check Jobs Status
    needs:
      - stale
    if: always()
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-check-jobs-status.yml@master

  # ---------------------------------------------------------------------------
  # Job: slack-workflow-status
  # What it does:
  #   - Posts the workflow result to Slack using a reusable workflow.
  #   - Triggered after the aggregated status-check job completes.
  # Why it exists:
  #   - Alerts maintainers if the stale automation fails.
  #   - Ensures repository hygiene automation remains reliable.
  # Noise control:
  #   - Only sends messages for failures or timeouts.
  # `ignore_jobs`:
  #   - Excludes the aggregator job from Slack summaries to reduce clutter.
  # Secrets:
  #   - Requires SLACK_WEBHOOK_URL to exist in repository secrets.
  # ---------------------------------------------------------------------------
  slack-workflow-status:
    name: Slack Post Workflow Notification
    needs:
      - status-check
    if: always()
    uses: the-lupaxa-project/workflows/.github/workflows/reusable-slack-workflow-status.yml@master
    with:
      # Comma-separated list of outcomes that should trigger Slack notifications.
      notify_on_results: "failure,timed_out"

      # Jobs to exclude from Slack message details.
      ignore_jobs: "Check Jobs Status"
    secrets:
      # Maps the repository’s Slack webhook secret into the reusable workflow.
      slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
